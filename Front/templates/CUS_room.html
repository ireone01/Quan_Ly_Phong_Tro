<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0">
	<title>Home</title>
	<link rel="shortcut icon" type="image/x-icon" href="../assets/img/3.png">
	<link rel="stylesheet" href="../assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="../assets/plugins/fontawesome/css/fontawesome.min.css">
	<link rel="stylesheet" href="../assets/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="../assets/css/feathericon.min.css">
	<link rel="stylesheet" href="../assets/plugins/datatables/datatables.min.css">
	<link rel="stylesheet" href="../assets/plugins/morris/morris.css">
	<link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-datetimepicker.min.css">
	<link rel="stylesheet" href="../assets/css/style.css">
</head>

<body>
<div class="main-wrapper">
	<div class="header">
		<div class="header-left">
			<a href="../templates/CUS_room.html" class="logo"> <img src="../assets/img/2.png" width="50" height="70" alt="logo"> <span class="logoclass">Phòng Trọ</span> </a>
			<a href="../templates/CUS_room.html" class="logo logo-small"> <img src="../assets/img/2.png" alt="Logo" width="30" height="30"> </a>
		</div>
		<a href="javascript:void(0);" id="toggle_btn"> <i class="fe fe-text-align-left"></i> </a>
		<ul class="nav user-menu">
			<li class="nav-item dropdown has-arrow">
				<a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown"> <span class="user-img"><img class="rounded-circle" src="../assets/img/1.png" width="31" alt="User"></span> </a>
				<div class="dropdown-menu">
					<div class="user-header">
						<div class="avatar avatar-sm"> <img src="../assets/img/1.png" alt="User Image" class="avatar-img rounded-circle"> </div>
						<div class="user-text">
							<h6 id="user-name-display">Người Thuê</h6>
							<p class="text-muted mb-0">Người Thuê</p>
						</div>
					</div>
					<a class="dropdown-item" href="../templates/CUS_customer.html">Thông Tin Cá Nhân</a>
					<a class="dropdown-item" href="../templates/CUS_change-password.html">Đổi Mật Khẩu</a>
					<a class="dropdown-item" href="#" onclick="logout()">Đăng Xuất</a>
				</div>
			</li>
		</ul>
	</div>
	<div class="sidebar" id="sidebar">
	</div>
	<div class="page-wrapper">
		<div class="content container-fluid">
			<div class="page-header">
				<div class="row align-items-center">
					<div class="col">
					</div>
				</div>
			</div>
			<div class="row" id="phong-tro-list">
			</div>
		</div>
		<div class="modal fade" id="roomModal" tabindex="-1" role="dialog" aria-labelledby="roomModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="roomModalLabel">Thông Tin Phòng</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="tab-content profile-tab-cont">
							<div class="tab-pane fade show active">
								<div class="row">
									<div class="col-lg-12">
										<div class="card">
											<div class="card-body">
												<div class="container mt-1">
													<div id="imageCarousel" class="carousel slide" data-ride="carousel">
														<ol class="carousel-indicators">
														</ol>
														<div class="carousel-inner">
														</div>
														<a class="carousel-control-prev" href="#imageCarousel" role="button" data-slide="prev">
															<span class="carousel-control-prev-icon" aria-hidden="true"></span>
															<span class="sr-only">Previous</span>
														</a>
														<a class="carousel-control-next" href="#imageCarousel" role="button" data-slide="next">
															<span class="carousel-control-next-icon" aria-hidden="true"></span>
															<span class="sr-only">Next</span>
														</a>
													</div>
												</div>
												<div class="modal fade" id="imageLargeModal" tabindex="-1" role="dialog" aria-labelledby="imageLargeModalLabel" aria-hidden="true">
													<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
														<div class="modal-content">
															<div class="modal-body">
																<img id="largeImage" src="" class="img-fluid" alt="Large Image">
															</div>
														</div>
													</div>
												</div>
												<div class="row mt-4">
													<div class="col-sm-12">
														<table class="table">
															<tr>
																<td class="text-right"><b>ID:</b></td>
																<td id="ID_Phong"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Tên Phòng:</b></td>
																<td id="TenPhong"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Số Người Tối Đa:</b></td>
																<td id="SoNguoiToiDa"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Diện Tích:</b></td>
																<td id="DienTich"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Giá Thuê:</b></td>
																<td id="GiaThue"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Đặc Điểm:</b></td>
																<td id="DacDiem"></td>
															</tr>
															<tr>
																<td class="text-right"><b>Tình Trạng:</b></td>
																<td id="TinhTrang"></td>
															</tr>
														</table>
														<button type="button" class="btn btn-primary mt-4">Thuê Phòng</button>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script src="../assets/js/jquery-3.5.1.min.js"></script>
<script src="../assets/js/popper.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/moment.min.js"></script>
<script src="../assets/js/select2.min.js"></script>
<script src="../assets/plugins/slimscroll/jquery.slimscroll.min.js"></script>
<script src="../assets/js/bootstrap-datetimepicker.min.js"></script>
<script src="../assets/plugins/datatables/datatables.min.js"></script>
<script src="../assets/js/script.js"></script>
<script>
	function checkLogin() {
		fetch('http://localhost:3001/userinfo', {
			credentials: 'include'
		})
				.then(response => {
					if (response.ok) {
						return response.json();
					} else {
						window.location.href = '../templates/login1.html';
					}
				})
				.then(user => {
					document.getElementById('user-name-display').textContent=user.TenKhachHang;
					fetchInvoices(user.ID_KhachHang); // Fetch invoices after login
				})
				.catch(error => {
					console.error('Lỗi khi kiểm tra đăng nhập:', error);
				});
	}

	async function logout() {
		try {
			const response = await fetch('http://localhost:3001/logout', {
				method: 'POST',
				credentials : 'include'
			});
			if (response.ok) {
				window.location.reload();
			} else {
				alert('Đăng xuất thất bại');
			}
		} catch (error) {
			console.error('Lỗi khi đăng xuất:', error);
			alert('Đã xảy ra lỗi khi đăng xuất');
		}
	}
	checkLogin();
	$(document).ready(function() {
		$.ajax({
			url: 'http://localhost:3001/Phong',
			type: 'GET',
			success: function(response) {
				const phongTroList = document.getElementById('phong-tro-list');
				response.forEach(phong => {
					const col = document.createElement('div');
					col.className = 'col-12 col-sm-8 col-md-6 col-lg-4';

					if (phong.TinhTrang) {
						col.innerHTML = `
								<div class="card bg-danger">
									<img class="card-img" src="${phong.Images}" alt="">
									<div class="card-body">
										<div class="info-row">
											<p class="label"><b>Tên Phòng:</b></p>
											<p class="value">${phong.TenPhong}</p>
											<p class="label"><b>Diện Tích:</b></p>
											<p class="value">${phong.DienTich} m²</p>
											<p class="label"><b>Giá:</b></p>
											<p class="value">${phong.GiaThue} đ</p>
											<p class="label"><b>Số Người Tối Đa:</b></p>
											<p class="value">${phong.SoNguoiToiDa}</p>
										</div>
										<button type="button" class="btn btn-primary view-room-details" data-toggle="modal" data-target="#roomModal" data-room-id="${phong.ID_Phong}">Xem Chi Tiết</button>
									</div>
								</div>
							`;
					} else {
						col.innerHTML = `
								<div class="card">
									<img class="card-img" src="${phong.Images}" alt="">
									<div class="card-body">
										<div class="info-row">
											<p class="label"><b>Tên Phòng:</b></p>
											<p class="value">${phong.TenPhong}</p>
											<p class="label"><b>Diện Tích:</b></p>
											<p class="value">${phong.DienTich} m²</p>
											<p class="label"><b>Giá:</b></p>
											<p class="value">${phong.GiaThue} đ</p>
											<p class="label"><b>Số Người Tối Đa:</b></p>
											<p class="value">${phong.SoNguoiToiDa}</p>
										</div>
										<button type="button" class="btn btn-primary view-room-details" data-toggle="modal" data-target="#roomModal" data-room-id="${phong.ID_Phong}">Xem Chi Tiết</button>
									</div>
								</div>
							`;
					}

					phongTroList.appendChild(col);

					// Gắn sự kiện click cho nút "Xem Chi Tiết"
					col.querySelector('.view-room-details').addEventListener('click', function() {
						const roomId = this.getAttribute('data-room-id');
						$.ajax({
							url: `http://localhost:3001/Phong/${roomId}`,
							type: 'GET',
							success: function(data) {
								document.getElementById('ID_Phong').innerText = data.ID_Phong;
								document.getElementById('TenPhong').innerText = data.TenPhong;
								document.getElementById('SoNguoiToiDa').innerText = data.SoNguoiToiDa;
								document.getElementById('DienTich').innerText = data.DienTich + ' m²';
								document.getElementById('GiaThue').innerText = data.GiaThue + ' đ';
								document.getElementById('DacDiem').innerText = data.DacDiem;
								document.getElementById('TinhTrang').innerText = data.TinhTrang ? 'Đã thuê' : 'Chưa được thuê';

								// Clear existing images
								$('.carousel-inner').empty();
								$('.carousel-indicators').empty();

								// Add new images
								const images = data.Images.split(" ");
								images.forEach((image, index) => {
									const imageSrc = image;
									const carouselItem = `<div class="carousel-item ${index === 0 ? 'active' : ''}">
											<a href="#" data-toggle="modal" data-target="#imageModal">
												<img src="${imageSrc}" class="d-block w-100 modal-trigger" alt="Image">
											</a>
										</div>`;
									$('.carousel-inner').append(carouselItem);

									const indicator = `<li data-target="#imageCarousel" data-slide-to="${index}" class="${index === 0 ? 'active' : ''}"></li>`;
									$('.carousel-indicators').append(indicator);
								});

								// Add click event for carousel images to show large image
								$('.carousel-item img').click(function() {
									const imageUrl = $(this).attr('src');
									$('#largeImage').attr('src', imageUrl);
									$('#imageLargeModal').modal('show');
								});

								// Show room modal
								$('#roomModal').modal('show');
							}
						});
					});
				});
			}
		});
	});

	$(document).ready(function() {
		$('#sidebar').load('../templates/sidebar_CUS.html', function() {
			// Gắn lại các sự kiện sau khi nội dung được tải xong
			$('.submenu > a').on('click', function(e) {
				e.preventDefault();
				const submenu = $(this).next('.submenu_class');
				if (submenu.is(':visible')) {
					submenu.slideUp();
				} else {
					submenu.slideDown();
				}
			});
		});
	});
</script>
</body>

</html>
